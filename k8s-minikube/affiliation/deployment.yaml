---
apiVersion: v1
kind: ConfigMap
metadata:
  name: affiliation-config
  namespace: microservices
data:
  DEBUG: "True"
  ALLOWED_HOSTS: "localhost,127.0.0.1,affiliation-web,affiliation-service,10.244.0.0/16,*"
  DATABASE_ENGINE: "django.db.backends.mysql"
  DATABASE_NAME: "citizen_affiliation"
  DATABASE_USER: "djangouser"
  DATABASE_HOST: "affiliation-db"
  DATABASE_PORT: "3306"
  REDIS_HOST: "affiliation-redis"
  REDIS_PORT: "6379"
  RABBITMQ_HOST: "rabbitmq"
  RABBITMQ_PORT: "5672"
  RABBITMQ_VHOST: "/"
  RABBITMQ_EXCHANGE: "citizen_affiliation"

---
apiVersion: v1
kind: Service
metadata:
  name: affiliation-service
  namespace: microservices
  labels:
    app: affiliation-service
spec:
  type: NodePort
  ports:
    - port: 8000
      targetPort: 8000
      nodePort: 30090
      name: http
  selector:
    app: affiliation-service

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: affiliation-service
  namespace: microservices
  labels:
    app: affiliation-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: affiliation-service
  template:
    metadata:
      labels:
        app: affiliation-service
    spec:
      enableServiceLinks: false  # Disable automatic service environment variables
      initContainers:
      - name: wait-for-db
        image: busybox:1.36
        command: ['sh', '-c', 'until nc -z affiliation-db 3306; do echo waiting for db; sleep 2; done;']
      - name: wait-for-redis
        image: busybox:1.36
        command: ['sh', '-c', 'until nc -z affiliation-redis 6379; do echo waiting for redis; sleep 2; done;']
      - name: wait-for-rabbitmq
        image: busybox:1.36
        command: ['sh', '-c', 'until nc -z rabbitmq 5672; do echo waiting for rabbitmq; sleep 2; done;']
      containers:
      - name: affiliation
        image: affiliation-service:latest
        imagePullPolicy: Never
        ports:
        - containerPort: 8000
          name: http
        env:
        - name: DEBUG
          valueFrom:
            configMapKeyRef:
              name: affiliation-config
              key: DEBUG
        - name: SECRET_KEY
          value: "django-insecure-development-key-change-in-production"
        - name: ALLOWED_HOSTS
          valueFrom:
            configMapKeyRef:
              name: affiliation-config
              key: ALLOWED_HOSTS
        - name: DATABASE_NAME
          valueFrom:
            secretKeyRef:
              name: mariadb-secret
              key: MYSQL_DATABASE
        - name: DATABASE_USER
          valueFrom:
            secretKeyRef:
              name: mariadb-secret
              key: MYSQL_USER
        - name: DATABASE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mariadb-secret
              key: MYSQL_PASSWORD
        - name: DATABASE_HOST
          valueFrom:
            configMapKeyRef:
              name: affiliation-config
              key: DATABASE_HOST
        - name: DATABASE_PORT
          valueFrom:
            configMapKeyRef:
              name: affiliation-config
              key: DATABASE_PORT
        - name: DATABASE_URL
          value: "mysql://djangouser:djangopass@affiliation-db:3306/citizen_affiliation"
        - name: REDIS_HOST
          valueFrom:
            configMapKeyRef:
              name: affiliation-config
              key: REDIS_HOST
        - name: REDIS_PORT
          valueFrom:
            configMapKeyRef:
              name: affiliation-config
              key: REDIS_PORT
        - name: RABBITMQ_HOST
          valueFrom:
            configMapKeyRef:
              name: affiliation-config
              key: RABBITMQ_HOST
        - name: RABBITMQ_PORT
          valueFrom:
            configMapKeyRef:
              name: affiliation-config
              key: RABBITMQ_PORT
        - name: RABBITMQ_USER
          valueFrom:
            secretKeyRef:
              name: rabbitmq-secret
              key: RABBITMQ_USER
        - name: RABBITMQ_PASSWORD
          valueFrom:
            secretKeyRef:
              name: rabbitmq-secret
              key: RABBITMQ_PASSWORD
        - name: RABBITMQ_VHOST
          valueFrom:
            configMapKeyRef:
              name: affiliation-config
              key: RABBITMQ_VHOST
        - name: RABBITMQ_EXCHANGE
          valueFrom:
            configMapKeyRef:
              name: affiliation-config
              key: RABBITMQ_EXCHANGE
        livenessProbe:
          httpGet:
            path: /health/
            port: 8000
          initialDelaySeconds: 60
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /health/
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: affiliation-document-consumer
  namespace: microservices
  labels:
    app: affiliation-document-consumer
spec:
  replicas: 1
  selector:
    matchLabels:
      app: affiliation-document-consumer
  template:
    metadata:
      labels:
        app: affiliation-document-consumer
    spec:
      enableServiceLinks: false  # Disable automatic service environment variables
      initContainers:
      - name: wait-for-db
        image: busybox:1.36
        command: ['sh', '-c', 'until nc -z affiliation-db 3306; do echo waiting for db; sleep 2; done;']
      - name: wait-for-rabbitmq
        image: busybox:1.36
        command: ['sh', '-c', 'until nc -z rabbitmq 5672; do echo waiting for rabbitmq; sleep 2; done;']
      containers:
      - name: consumer
        image: affiliation-service:latest
        imagePullPolicy: Never
        command: ["python", "manage.py", "consume_document_auth"]
        env:
        - name: DEBUG
          valueFrom:
            configMapKeyRef:
              name: affiliation-config
              key: DEBUG
        - name: SECRET_KEY
          value: "django-insecure-development-key-change-in-production"
        - name: DATABASE_URL
          value: "mysql://djangouser:djangopass@affiliation-db:3306/citizen_affiliation"
        - name: DATABASE_ENGINE
          valueFrom:
            configMapKeyRef:
              name: affiliation-config
              key: DATABASE_ENGINE
        - name: DATABASE_NAME
          valueFrom:
            secretKeyRef:
              name: mariadb-secret
              key: MYSQL_DATABASE
        - name: DATABASE_USER
          valueFrom:
            secretKeyRef:
              name: mariadb-secret
              key: MYSQL_USER
        - name: DATABASE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mariadb-secret
              key: MYSQL_PASSWORD
        - name: DATABASE_HOST
          valueFrom:
            configMapKeyRef:
              name: affiliation-config
              key: DATABASE_HOST
        - name: DATABASE_PORT
          valueFrom:
            configMapKeyRef:
              name: affiliation-config
              key: DATABASE_PORT
        - name: REDIS_HOST
          valueFrom:
            configMapKeyRef:
              name: affiliation-config
              key: REDIS_HOST
        - name: REDIS_PORT
          valueFrom:
            configMapKeyRef:
              name: affiliation-config
              key: REDIS_PORT
        - name: RABBITMQ_HOST
          valueFrom:
            configMapKeyRef:
              name: affiliation-config
              key: RABBITMQ_HOST
        - name: RABBITMQ_PORT
          valueFrom:
            configMapKeyRef:
              name: affiliation-config
              key: RABBITMQ_PORT
        - name: RABBITMQ_USER
          valueFrom:
            secretKeyRef:
              name: rabbitmq-secret
              key: RABBITMQ_USER
        - name: RABBITMQ_PASSWORD
          valueFrom:
            secretKeyRef:
              name: rabbitmq-secret
              key: RABBITMQ_PASSWORD
        - name: RABBITMQ_VHOST
          valueFrom:
            configMapKeyRef:
              name: affiliation-config
              key: RABBITMQ_VHOST
        - name: RABBITMQ_EXCHANGE
          valueFrom:
            configMapKeyRef:
              name: affiliation-config
              key: RABBITMQ_EXCHANGE
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"

---
apiVersion: batch/v1
kind: Job
metadata:
  name: affiliation-migrations
  namespace: microservices
  labels:
    app: affiliation-migrations
spec:
  template:
    spec:
      restartPolicy: OnFailure
      enableServiceLinks: false  # Disable automatic service environment variables
      initContainers:
      - name: wait-for-db
        image: busybox:1.36
        command: ['sh', '-c', 'until nc -z affiliation-db 3306; do echo waiting for db; sleep 2; done; sleep 10;']
      containers:
      - name: migrations
        image: affiliation-service:latest
        imagePullPolicy: Never
        command:
        - /bin/bash
        - -c
        - |
          python manage.py migrate --noinput
          python manage.py shell << 'PYTHON_EOF'
          from django.contrib.auth import get_user_model
          User = get_user_model()
          
          # Create auth-service user
          if not User.objects.filter(username='auth-service').exists():
              User.objects.create_user('auth-service', password='auth-service-pass-123')
              print('Auth service user created')
          else:
              print('Auth service user already exists')
          
          # Create document-service user
          if not User.objects.filter(username='document-service').exists():
              User.objects.create_user('document-service', password='doc-service-pass-123')
              print('Document service user created')
          else:
              print('Document service user already exists')
          
          # Create Django admin superuser
          if not User.objects.filter(username='admin').exists():
              User.objects.create_superuser('admin', 'admin@connectivity.local', 'admin123')
              print('Django admin superuser created')
          else:
              print('Django admin superuser already exists')
          PYTHON_EOF
        env:
        - name: DEBUG
          valueFrom:
            configMapKeyRef:
              name: affiliation-config
              key: DEBUG
        - name: SECRET_KEY
          value: "django-insecure-development-key-change-in-production"
        - name: DATABASE_ENGINE
          valueFrom:
            configMapKeyRef:
              name: affiliation-config
              key: DATABASE_ENGINE
        - name: DATABASE_NAME
          valueFrom:
            secretKeyRef:
              name: mariadb-secret
              key: MYSQL_DATABASE
        - name: DATABASE_USER
          valueFrom:
            secretKeyRef:
              name: mariadb-secret
              key: MYSQL_USER
        - name: DATABASE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mariadb-secret
              key: MYSQL_PASSWORD
        - name: DATABASE_HOST
          valueFrom:
            configMapKeyRef:
              name: affiliation-config
              key: DATABASE_HOST
        - name: DATABASE_PORT
          valueFrom:
            configMapKeyRef:
              name: affiliation-config
              key: DATABASE_PORT
        - name: DATABASE_URL
          value: "mysql://djangouser:djangopass@affiliation-db:3306/citizen_affiliation"
---
